version: "3.9"

services:
  kafka:
    image: bitnami/kafka:3.9
    container_name: aiqo-kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - ALLOW_PLAINTEXT_LISTENER=yes
    networks:
      - aiqo-net

  postgres:
    image: postgres:17
    container_name: aiqo-postgres
    environment:
      POSTGRES_USER: aiqo
      POSTGRES_PASSWORD: aiqo
      POSTGRES_DB: aiqo
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ../aiqo-persistence/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"
    networks:
      - aiqo-net

  persistence:
    build:
      context: ../aiqo-persistence
    container_name: aiqo-persistence
    depends_on:
      - postgres
      - kafka
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/aiqo?currentSchema=aiqo
      SPRING_DATASOURCE_USERNAME: aiqo
      SPRING_DATASOURCE_PASSWORD: aiqo
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      AIQO_KAFKA_TASKS_TOPIC: aiqo.tasks
      AIQO_KAFKA_HINTS_TOPIC: aiqo.hints
      AIQO_KAFKA_COLLECTOR_TOPIC: aiqo.collector.runs
    ports:
      - "8081:8081"
    networks:
      - aiqo-net

  submitter:
    build:
      context: ../aiqo-ai-submitter
    container_name: aiqo-submitter
    depends_on:
      - kafka
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      AIQO_KAFKA_TASKS_TOPIC: aiqo.tasks
      AIQO_KAFKA_HINTS_TOPIC: aiqo.hints
    ports:
      - "8082:8082"
    networks:
      - aiqo-net

  collector:
    build:
      context: ../aiqo-collector
    container_name: aiqo-collector
    depends_on:
      - kafka
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      COLLECTOR_APPLICATION: CollectorApp
      COLLECTOR_TENANT: 1
      COLLECTOR_ENVIRONMENT: DEV
      COLLECTOR_LOCAL_DIRECTORY: /data/logs
      COLLECTOR_LOCAL_FILE-PATTERNS: "*.log"
    volumes:
      - ./logs:/data/logs
    networks:
      - aiqo-net

volumes:
  pgdata:

networks:
  aiqo-net:
